<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Admin Dashboard - TCWD Portal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #dc3545 0%, #e55472 100%);
            color: white;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 10px;
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: whit                    <select id="createUserRole" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Select Role</option>
                        <option value="admin">Admin</option>
                        <option value="manager">Manager</option>
                        <option value="viewer">Viewer</option>
                        <option value="guest">Guest</option>
                    </select>        border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #003366;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 14px;
            text-transform: uppercase;
        }
        
        .admin-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section-title {
            color: #003366;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .user-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .user-table th,
        .user-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        .user-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        .role-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .role-admin { background: #dc3545; color: white; }
        .role-manager { background: #fd7e14; color: white; }
        .role-viewer { background: #198754; color: white; }
        .role-guest { background: #6c757d; color: white; }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            margin: 2px;
        }
        
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-success { background: #28a745; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        
        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #007bff;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .navigation {
            background: #003366;
            padding: 10px 20px;
            margin-bottom: 20px;
        }
        
        .navigation a {
            color: white;
            text-decoration: none;
            margin-right: 20px;
            padding: 8px 16px;
            border-radius: 4px;
            transition: background 0.3s;
        }
        
        .navigation a:hover,
        .navigation a.active {
            background: rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>
    <div class="navigation">
        <a href="{{ url_for('index') }}"><i class="fas fa-home"></i> Dashboard</a>
        <a href="{{ url_for('manager_dashboard') }}"><i class="fas fa-chart-bar"></i> Analytics</a>
        <a href="{{ url_for('admin_dashboard') }}" class="active"><i class="fas fa-cog"></i> Admin</a>
        <a href="{{ url_for('logout') }}" style="float: right;"><i class="fas fa-sign-out-alt"></i> Logout</a>
        <span style="float: right; margin-right: 20px; color: white;">
            <i class="fas fa-user-shield"></i> {{ user.full_name }} ({{ user.role.upper() }})
        </span>
    </div>

    <div class="container">
        <div class="admin-header">
            <h1><i class="fas fa-shield-alt"></i> Administrator Dashboard</h1>
            <p>Complete system management and monitoring</p>
        </div>

        <!-- System Statistics -->
        <div class="admin-stats">
            <div class="stat-card">
                <div class="stat-number">{{ "{:,}".format(stats.total_users) }}</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ "{:,}".format(stats.active_users) }}</div>
                <div class="stat-label">Active Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ "{:,}".format(stats.recent_logins) }}</div>
                <div class="stat-label">Recent Logins (24h)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ "{:,}".format(stats.total_customers) }}</div>
                <div class="stat-label">Total Records</div>
            </div>
        </div>

        <!-- User Management -->
                            <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3><i class="fas fa-users"></i> User Management</h3>
                            <div>
                                <button class="btn btn-success btn-sm" onclick="showCreateUserModal()">
                                    <i class="fas fa-user-plus"></i> Create User
                                </button>
                                <button class="btn btn-info btn-sm" onclick="exportUsers()">
                                    <i class="fas fa-download"></i> Export CSV
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="showImportModal()">
                                    <i class="fas fa-upload"></i> Import CSV
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="testButton()" style="margin-left: 10px;">
                                    <i class="fas fa-bug"></i> Test
                                </button>
                            </div>
                            
                            <!-- User View Toggle -->
                            <div style="margin: 15px 0;">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="showAllUsersToggle" onchange="toggleUserView()">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span style="margin-left: 10px; font-weight: bold;">Show Inactive Users</span>
                                <small style="color: #6c757d; margin-left: 10px;">(Include deleted/deactivated users)</small>
                            </div>
                        </div>
            <div class="table-responsive">
                <table class="user-table" id="usersTable">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 20px;">
                                <i class="fas fa-spinner fa-spin"></i> Loading users...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- User Activity Monitor -->
        <div style="margin-bottom: 20px;">
            <div class="admin-section">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                    <h3 class="section-title"><i class="fas fa-chart-line"></i> Real-time User Activity</h3>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleActivityMonitor()">
                        <i class="fas fa-play" id="activityToggleIcon"></i> <span id="activityToggleText">Start Monitor</span>
                    </button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div style="text-align: center; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
                        <h3 style="color: #28a745; margin: 0;" id="activeUsersCount">0</h3>
                        <small style="color: #6c757d;">Active Users (Last 5 mins)</small>
                    </div>
                    <div style="text-align: center; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
                        <h3 style="color: #17a2b8; margin: 0;" id="totalSessionsCount">0</h3>
                        <small style="color: #6c757d;">Total Sessions Today</small>
                    </div>
                </div>
                <div>
                    <h6>Recent Activity <span style="background: #007bff; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;" id="activityBadge">Stopped</span></h6>
                    <div id="activityFeed" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px; background: #f8f9fa;">
                        <div style="text-align: center; color: #6c757d;">Activity monitor is stopped. Click "Start Monitor" to begin.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Upload Management -->
        <div class="admin-section" style="margin-bottom: 30px;">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                <h3 class="section-title"><i class="fas fa-database"></i> Database Management - Monthly Data Upload</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success btn-sm" onclick="showUploadModal()">
                        <i class="fas fa-upload"></i> Upload New Month Data
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="showDeleteModal()">
                        <i class="fas fa-trash"></i> Delete Month Data
                    </button>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div style="text-align: center; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f8f9fa;">
                    <h4 style="color: #007bff; margin: 0;" id="totalRecords">-</h4>
                    <small style="color: #6c757d;">Latest Month Records</small>
                </div>
                <div style="text-align: center; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f8f9fa;">
                    <h4 style="color: #28a745; margin: 0;" id="latestMonth">-</h4>
                    <small style="color: #6c757d;">Latest Month</small>
                </div>
                <div style="text-align: center; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f8f9fa;">
                    <h4 style="color: #dc3545; margin: 0;" id="availableMonths">-</h4>
                    <small style="color: #6c757d;">Available Months</small>
                </div>
            </div>
            
            <div style="background: #e9ecef; padding: 15px; border-radius: 8px;">
                <h6 style="color: #495057; margin-bottom: 10px;"><i class="fas fa-info-circle"></i> Upload Instructions</h6>
                <ul style="margin: 0; padding-left: 20px; color: #6c757d;">
                    <li>Upload GeoPackage (.gpkg) file with water consumption data for a new month</li>
                    <li>Required columns: Type, AccountNumber, Name, Address, MeterNo, BookNo, RateCode, Status, Cellphone, SeqNo, AREA, x, y, PRVReading, PRSReading, CumUsed, BillAmount, Year, Month</li>
                    <li>File must contain consistent Year and Month data for all records</li>
                    <li>Duplicate data for existing Year/Month combinations will be rejected</li>
                </ul>
                <button onclick="downloadDataTemplate()" class="btn btn-info btn-sm" style="margin-top: 10px;">
                    <i class="fas fa-download"></i> Download Template GPKG
                </button>
            </div>
        </div>

        <!-- System Management -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="admin-section">
                <h3 class="section-title"><i class="fas fa-memory"></i> Cache Management</h3>
                <p>Manage application cache for optimal performance.</p>
                <div style="margin-bottom: 15px;">
                    <span>Cache Items: <strong id="cacheItems">Loading...</strong></span><br>
                    <span>Total Accesses: <strong id="cacheAccesses">Loading...</strong></span>
                </div>
                <button class="btn btn-warning" onclick="clearCache()">
                    <i class="fas fa-trash"></i> Clear Cache
                </button>
                <button class="btn btn-primary" onclick="refreshCacheStats()">
                    <i class="fas fa-sync-alt"></i> Refresh Stats
                </button>
            </div>

            <div class="admin-section">
                <h3 class="section-title"><i class="fas fa-history"></i> Recent Activity</h3>
                <div id="auditLog" style="max-height: 300px; overflow-y: auto;">
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-spinner fa-spin"></i> Loading activity logs...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configure CSRF token for all AJAX requests
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        // Configure fetch to include CSRF token
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            if (args[1] && args[1].method && args[1].method.toLowerCase() !== 'get') {
                args[1].headers = args[1].headers || {};
                args[1].headers['X-CSRFToken'] = csrfToken;
            }
            return originalFetch.apply(this, args);
        };
        
        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Admin dashboard DOM loaded, initializing...');
            loadUsers();
            loadCacheStats();
            loadAuditLogs();
            loadDatabaseStats();
            console.log('✅ All admin dashboard functions called');
        });

        function loadUsers(showAll = false) {
            console.log('Loading users, showAll:', showAll);
            const url = showAll ? '/api/admin/users?show_all=true' : '/api/admin/users';
            const tbody = document.querySelector('#usersTable tbody');
            
            if (!tbody) {
                console.error('Users table tbody not found');
                return;
            }
            
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> Loading users...</td></tr>';
            
            fetch(url)
                .then(response => {
                    console.log('API response status:', response.status);
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status + ' ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Users data received:', data);
                    tbody.innerHTML = '';
                    
                    if (!data.users || data.users.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No users found</td></tr>';
                        return;
                    }
                    
                    data.users.forEach(user => {
                        const lastLogin = user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never';
                        const statusBadge = user.is_active ? 
                            '<span style="background: #198754; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">ACTIVE</span>' : 
                            '<span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">INACTIVE</span>';
                        
                        let actionButtons = '';
                        if (user.is_active) {
                            actionButtons = `
                                <button class="btn btn-warning" onclick="editUser(${user.id})" style="margin: 2px;">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-danger" onclick="deleteUser(${user.id}, &quot;${user.username.replace(/"/g, '&quot;')}&quot;)" style="margin: 2px;">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            `;
                        } else {
                            actionButtons = `
                                <button class="btn btn-success" onclick="restoreUser(${user.id}, &quot;${user.username.replace(/"/g, '&quot;')}&quot;)" style="margin: 2px;">
                                    <i class="fas fa-undo"></i> Restore
                                </button>
                                <button class="btn btn-danger" onclick="permanentDeleteUser(${user.id}, &quot;${user.username.replace(/"/g, '&quot;')}&quot;)" style="margin: 2px;" title="Permanent Delete - Cannot be undone!">
                                    <i class="fas fa-trash-alt"></i> Permanent
                                </button>
                            `;
                        }
                        
                        const row = document.createElement('tr');
                        if (!user.is_active) {
                            row.style.opacity = '0.6';
                            row.style.backgroundColor = '#f8f9fa';
                        }
                        
                        row.innerHTML = `
                            <td><strong>${user.full_name || user.username}</strong><br><small>@${user.username}</small></td>
                            <td>${user.email || 'N/A'}</td>
                            <td><span class="role-badge role-${user.role}">${user.role.toUpperCase()}</span></td>
                            <td>${statusBadge}</td>
                            <td><small>${lastLogin}</small></td>
                            <td>${actionButtons}</td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error loading users:', error);
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #dc3545;">Error loading users: ' + error.message + '</td></tr>';
                });
        }

        // Toggle between showing active only vs all users
        function toggleUserView() {
            const toggle = document.getElementById('showAllUsersToggle');
            loadUsers(toggle.checked);
        }

        // Restore (reactivate) user
        function restoreUser(userId, username) {
            if (confirm(`Restore user "${username}"? This will reactivate their account.`)) {
                fetch(`/api/admin/users/${userId}/restore`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`User "${username}" restored successfully!`);
                        const toggle = document.getElementById('showAllUsersToggle');
                        loadUsers(toggle.checked); // Reload with current view setting
                    } else {
                        alert(`Error restoring user: ${data.error || data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Error restoring user:', error);
                    alert('Error restoring user. Please try again.');
                });
            }
        }

        // Permanent delete user (cannot be undone)
        function permanentDeleteUser(userId, username) {
            if (confirm(`⚠️ PERMANENT DELETE WARNING ⚠️\n\nThis will permanently delete user "${username}" from the database.\n\nTHIS CANNOT BE UNDONE!\n\nAre you absolutely sure?`)) {
                if (confirm(`Final confirmation: Delete "${username}" permanently?`)) {
                    fetch(`/api/admin/users/${userId}/permanent-delete`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(`User "${username}" permanently deleted.`);
                            const toggle = document.getElementById('showAllUsersToggle');
                            loadUsers(toggle.checked); // Reload with current view setting
                        } else {
                            alert(`Error deleting user: ${data.error || data.message}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting user:', error);
                        alert('Error deleting user. Please try again.');
                    });
                }
            }
        }

        function loadCacheStats() {
            fetch('/api/admin/cache/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('cacheItems').textContent = data.total_items;
                    document.getElementById('cacheAccesses').textContent = data.total_accesses;
                })
                .catch(error => console.error('Error loading cache stats:', error));
        }

        function loadAuditLogs() {
            fetch('/api/admin/audit-logs?per_page=10')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('auditLog');
                    container.innerHTML = '';
                    
                    data.logs.forEach(log => {
                        const logTime = new Date(log.timestamp).toLocaleString();
                        container.innerHTML += `
                            <div style="padding: 8px; border-bottom: 1px solid #eee; font-size: 12px;">
                                <strong>${(log.action || 'Unknown').replace(/_/g, ' ').toUpperCase()}</strong><br>
                                <small>${log.full_name || log.username || 'System'} - ${logTime}</small><br>
                                <small style="color: #6c757d;">${log.details || log.resource || 'No details'}</small>
                            </div>
                        `;
                    });
                })
                .catch(error => {
                    console.error('Error loading audit logs:', error);
                    document.getElementById('auditLog').innerHTML = 
                        '<div style="text-align: center; color: #dc3545; padding: 20px;">Error loading activity logs</div>';
                });
        }

        function clearCache() {
            if (confirm('Are you sure you want to clear the cache?')) {
                fetch('/api/admin/cache/clear', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                        loadCacheStats();
                    })
                    .catch(error => {
                        console.error('Error clearing cache:', error);
                        alert('Error clearing cache');
                    });
            }
        }

        function refreshCacheStats() {
            loadCacheStats();
        }

        function editUser(userId) {
            // Fetch user data and populate edit modal
            fetch(`/api/admin/users/${userId}`)
                .then(response => response.json())
                .then(user => {
                    if (user.error) {
                        alert('Error fetching user data: ' + user.error);
                        return;
                    }
                    
                    // Populate the edit form
                    document.getElementById('editUserId').value = user.id;
                    document.getElementById('editUsername').value = user.username;
                    document.getElementById('editFullName').value = user.full_name || '';
                    document.getElementById('editEmail').value = user.email || '';
                    document.getElementById('editRole').value = user.role;
                    document.getElementById('editIsActive').checked = user.is_active;
                    document.getElementById('editPassword').value = '';
                    
                    // Show the modal
                    document.getElementById('editUserModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error fetching user:', error);
                    alert('Error fetching user data');
                });
        }

        function hideEditUserModal() {
            document.getElementById('editUserModal').style.display = 'none';
        }

        function updateUser() {
            const userId = document.getElementById('editUserId').value;
            const fullName = document.getElementById('editFullName').value;
            const email = document.getElementById('editEmail').value;
            const role = document.getElementById('editRole').value;
            const password = document.getElementById('editPassword').value;
            const isActive = document.getElementById('editIsActive').checked;

            if (!fullName || !role) {
                alert('Please fill in all required fields');
                return;
            }

            const userData = {
                full_name: fullName,
                email: email,
                role: role,
                is_active: isActive
            };

            // Only include password if it's not empty
            if (password && password.trim() !== '') {
                userData.password = password;
            }

            fetch(`/api/admin/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    hideEditUserModal();
                    loadUsers(); // Reload users table
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error updating user:', error);
                alert('Error updating user');
            });
        }

        function deleteUser(userId, username) {
            if (confirm(`Are you sure you want to delete user "${username}"? This will deactivate their account.`)) {
                fetch(`/api/admin/users/${userId}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            const toggle = document.getElementById('showAllUsersToggle');
                            loadUsers(toggle.checked); // Reload users table with current toggle setting
                        } else {
                            alert('Error: ' + (data.error || data.message || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting user:', error);
                        alert('Error deleting user');
                    });
            }
        }

        function toggleUser(userId) {
            alert('Toggle user status functionality would be implemented here.');
        }

        // Bulk Operations Functions
        function exportUsers() {
            fetch('/api/admin/users/export')
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'users_export_' + new Date().toISOString().split('T')[0] + '.csv';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => {
                    console.error('Error exporting users:', error);
                    alert('Error exporting users');
                });
        }

        function showImportModal() {
            document.getElementById('importUserModal').style.display = 'block';
        }

        function hideImportModal() {
            document.getElementById('importUserModal').style.display = 'none';
        }

        function downloadTemplate() {
            const csv = 'username,full_name,email,role,password\nexample_user,John Doe,john@example.com,guest,password123';
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'user_import_template.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function importUsers() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            fetch('/api/admin/users/import', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message + '\nCreated: ' + data.created + ', Errors: ' + data.errors);
                    hideImportModal();
                    loadUsers();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error importing users:', error);
                alert('Error importing users');
            });
        }

        // Database Upload Functions
        function showUploadModal() {
            document.getElementById('uploadDatabaseModal').style.display = 'block';
            loadDatabaseStats();
        }

        function hideUploadModal() {
            document.getElementById('uploadDatabaseModal').style.display = 'none';
            // Reset form
            document.getElementById('uploadYear').value = new Date().getFullYear();
            document.getElementById('uploadMonth').value = '';
            document.getElementById('databaseFile').value = '';
            document.getElementById('uploadProgress').style.display = 'none';
        }

        function downloadDataTemplate() {
            // Note: Downloads CSV template showing required column structure for reference
            // Users should create GPKG files with the same column structure
            const csv = `Type,AccountNumber,Name,Address,MeterNo,BookNo,RateCode,Status,Cellphone,SeqNo,AREA,x,y,PRVReading,PRSReading,CumUsed,BillAmount,Year,Month
SINGLE,1121200001,SAMPLE USER,Sample Address,17-00000,001,01,ACTIVE,09000000000,1,CENTRAL,123.123456,10.123456,1000,1010,10,250.50,2025,January`;
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tcwd_data_template_structure.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            alert('Template downloaded!\n\nNote: This CSV shows the required column structure.\nPlease create your GeoPackage file with the same columns and data types.');
        }

        function loadDatabaseStats() {
            console.log('🔍 loadDatabaseStats called');
            fetch('/api/admin/database/stats')
                .then(response => {
                    console.log('📡 Database stats API response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('📊 Database stats data received:', data);
                    if (data.success) {
                        document.getElementById('totalRecords').textContent = data.total_records.toLocaleString();
                        document.getElementById('latestMonth').textContent = data.latest_month;
                        document.getElementById('availableMonths').textContent = data.available_months;
                        console.log('✅ Database stats updated successfully');
                    } else {
                        console.error('❌ Database stats API returned error:', data);
                    }
                })
                .catch(error => {
                    console.error('❌ Error loading database stats:', error);
                });
        }

        function uploadDatabase() {
            const year = document.getElementById('uploadYear').value;
            const month = document.getElementById('uploadMonth').value;
            const fileInput = document.getElementById('databaseFile');
            const file = fileInput.files[0];
            
            if (!year || !month) {
                alert('Please select both year and month');
                return;
            }
            
            if (!file) {
                alert('Please select a GeoPackage file');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.gpkg')) {
                alert('Please select a valid GeoPackage (.gpkg) file');
                return;
            }

            // Show progress
            document.getElementById('uploadProgress').style.display = 'block';
            document.getElementById('uploadButton').disabled = true;

            const formData = new FormData();
            formData.append('file', file);
            formData.append('year', year);
            formData.append('month', month);

            fetch('/api/admin/database/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('uploadProgress').style.display = 'none';
                document.getElementById('uploadButton').disabled = false;
                
                if (data.success) {
                    alert(`Database upload successful!\\n\\nRecords processed: ${data.records_processed}\\nRecords added: ${data.records_added}\\nMonth: ${data.month} ${data.year}`);
                    hideUploadModal();
                    loadDatabaseStats();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error uploading database:', error);
                document.getElementById('uploadProgress').style.display = 'none';
                document.getElementById('uploadButton').disabled = false;
                alert('Error uploading database. Please try again.');
            });
        }

        // Database Delete Functions
        function showDeleteModal() {
            document.getElementById('deleteDataModal').style.display = 'block';
            // Reset form
            document.getElementById('deleteYear').value = new Date().getFullYear();
            document.getElementById('deleteMonth').value = '';
            document.getElementById('deletePreview').style.display = 'none';
            document.getElementById('deleteButton').style.display = 'none';
        }

        function hideDeleteModal() {
            document.getElementById('deleteDataModal').style.display = 'none';
        }

        function checkRecordsToDelete() {
            const year = document.getElementById('deleteYear').value;
            const month = document.getElementById('deleteMonth').value;
            
            if (!year || !month) {
                alert('Please select both year and month');
                return;
            }

            // Show loading state
            document.getElementById('deletePreviewCount').textContent = 'Loading...';
            document.getElementById('deletePreview').style.display = 'block';
            document.getElementById('checkDeleteButton').disabled = true;

            fetch(`/api/admin/database/check-records?year=${year}&month=${month}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('checkDeleteButton').disabled = false;
                    
                    if (data.success) {
                        const recordCount = data.record_count;
                        document.getElementById('deletePreviewCount').textContent = 
                            `${recordCount} records found for ${month} ${year}`;
                        
                        if (recordCount > 0) {
                            document.getElementById('deleteButton').style.display = 'inline-block';
                        } else {
                            document.getElementById('deleteButton').style.display = 'none';
                            alert('No records found for the selected month/year.');
                        }
                    } else {
                        document.getElementById('deletePreview').style.display = 'none';
                        alert('Error checking records: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error checking records:', error);
                    document.getElementById('checkDeleteButton').disabled = false;
                    document.getElementById('deletePreview').style.display = 'none';
                    alert('Error checking records. Please try again.');
                });
        }

        function deleteMonthData() {
            const year = document.getElementById('deleteYear').value;
            const month = document.getElementById('deleteMonth').value;
            
            if (!year || !month) {
                alert('Please select both year and month');
                return;
            }

            // Double confirmation
            const recordCount = document.getElementById('deletePreviewCount').textContent;
            const confirmed = confirm(
                `⚠️ WARNING: This action cannot be undone!\n\n` +
                `Are you absolutely sure you want to delete ${recordCount}?\n\n` +
                `This will permanently remove all data for ${month} ${year}.`
            );
            
            if (!confirmed) {
                return;
            }

            // Show loading state
            document.getElementById('deleteButton').disabled = true;
            document.getElementById('deleteButton').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';

            fetch('/api/admin/database/delete-month', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    year: parseInt(year),
                    month: month
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('deleteButton').disabled = false;
                document.getElementById('deleteButton').innerHTML = '<i class="fas fa-trash"></i> Delete Data';
                
                if (data.success) {
                    alert(`✅ Success!\n\nDeleted ${data.records_deleted} records for ${month} ${year}.`);
                    hideDeleteModal();
                    loadDatabaseStats(); // Refresh the stats
                } else {
                    alert('❌ Error deleting data: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error deleting data:', error);
                document.getElementById('deleteButton').disabled = false;
                document.getElementById('deleteButton').innerHTML = '<i class="fas fa-trash"></i> Delete Data';
                alert('Error deleting data. Please try again.');
            });
        }

        // Activity Monitor Functions
        let activityMonitorInterval = null;
        let isMonitoringActive = false;

        function toggleActivityMonitor() {
            if (isMonitoringActive) {
                stopActivityMonitor();
            } else {
                startActivityMonitor();
            }
        }

        function startActivityMonitor() {
            isMonitoringActive = true;
            document.getElementById('activityToggleIcon').className = 'fas fa-pause';
            document.getElementById('activityToggleText').textContent = 'Stop Monitor';
            document.getElementById('activityBadge').textContent = 'Live';
            document.getElementById('activityBadge').style.background = '#28a745';
            updateActivityStats();
            activityMonitorInterval = setInterval(updateActivityStats, 30000);
            addActivityMessage('Activity monitoring started', 'system');
        }

        function stopActivityMonitor() {
            isMonitoringActive = false;
            document.getElementById('activityToggleIcon').className = 'fas fa-play';
            document.getElementById('activityToggleText').textContent = 'Start Monitor';
            document.getElementById('activityBadge').textContent = 'Stopped';
            document.getElementById('activityBadge').style.background = '#6c757d';
            if (activityMonitorInterval) {
                clearInterval(activityMonitorInterval);
                activityMonitorInterval = null;
            }
            addActivityMessage('Activity monitoring stopped', 'system');
        }

        function updateActivityStats() {
            fetch('/api/admin/activity-stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('activeUsersCount').textContent = data.active_users || 0;
                    document.getElementById('totalSessionsCount').textContent = data.total_sessions || 0;
                    if (data.recent_activities && data.recent_activities.length > 0) {
                        data.recent_activities.forEach(activity => {
                            addActivityMessage(
                                activity.username + ': ' + activity.action + ' (' + activity.details + ')',
                                'activity'
                            );
                        });
                    }
                })
                .catch(error => {
                    console.error('Error updating activity stats:', error);
                    addActivityMessage('Error updating activity stats', 'error');
                });
        }

        function addActivityMessage(message, type) {
            const feed = document.getElementById('activityFeed');
            const timestamp = new Date().toLocaleTimeString();
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = 'padding: 5px; margin-bottom: 5px; border-radius: 3px; font-size: 12px;';
            let backgroundColor, textColor, icon;
            switch(type) {
                case 'system':
                    backgroundColor = '#e3f2fd'; textColor = '#1976d2'; icon = '⚙️'; break;
                case 'error':
                    backgroundColor = '#ffebee'; textColor = '#d32f2f'; icon = '❌'; break;
                default:
                    backgroundColor = '#f3e5f5'; textColor = '#7b1fa2'; icon = '👤';
            }
            messageDiv.style.backgroundColor = backgroundColor;
            messageDiv.style.color = textColor;
            messageDiv.innerHTML = '<span style="opacity: 0.7;">' + timestamp + '</span> ' + icon + ' ' + message;
            if (feed.firstChild && feed.firstChild.style.textAlign !== 'center') {
                feed.insertBefore(messageDiv, feed.firstChild);
            } else {
                feed.innerHTML = ''; feed.appendChild(messageDiv);
            }
            while (feed.children.length > 20) { feed.removeChild(feed.lastChild); }
            feed.scrollTop = 0;
        }

        // Test function to check if JavaScript is working
        function testButton() {
            alert('✅ JavaScript is working! \n✅ Button clicks are functional! \n\nIf you see this message, the basic functionality is working.');
            console.log('Test button clicked - JavaScript is working');
        }

        function showCreateUserModal() {
            console.log('showCreateUserModal() called');
            const modal = document.getElementById('createUserModal');
            console.log('Modal element:', modal);
            if (modal) {
                modal.style.display = 'block';
                console.log('Modal display set to block');
            } else {
                console.error('Modal element not found!');
                alert('Modal not found! Check console for details.');
            }
        }

        function hideCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'none';
            document.getElementById('createUserForm').reset();
        }

        function createUser() {
            const formData = new FormData(document.getElementById('createUserForm'));
            const userData = {
                username: formData.get('username'),
                full_name: formData.get('full_name'),
                email: formData.get('email'),
                role: formData.get('role'),
                password: formData.get('password')
            };

            // Validate required fields
            if (!userData.username || !userData.full_name || !userData.role || !userData.password) {
                alert('Please fill in all required fields');
                return;
            }

            fetch('/api/admin/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userData)
            })
            .then(response => {
                const isSuccess = response.status === 201;
                return response.json().then(data => ({ data, isSuccess }));
            })
            .then(({ data, isSuccess }) => {
                if (isSuccess || data.message) {
                    alert(data.message || 'User created successfully');
                    hideCreateUserModal();
                    loadUsers(); // Reload users table
                } else {
                    alert('Error: ' + (data.error || data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error creating user:', error);
                alert('Error creating user: ' + error.message);
            });
        }

        // Auto-refresh every 30 seconds
        setInterval(() => {
            loadCacheStats();
            loadAuditLogs();
        }, 30000);

        // ============================================================================
        // AUTO LOGOUT FUNCTIONALITY
        // ============================================================================
        
        (function() {
            const IDLE_TIMEOUT = {{ idle_timeout_ms }};  // 20 minutes in milliseconds
            const WARNING_TIME = 2 * 60 * 1000;  // Show warning 2 minutes before logout
            
            let idleTimer;
            let warningTimer;
            let warningShown = false;
            
            // Track user activity
            const activities = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
            
            function resetIdleTimer() {
                clearTimeout(idleTimer);
                clearTimeout(warningTimer);
                warningShown = false;
                
                // Remove warning if it exists
                const existingWarning = document.getElementById('idle-warning');
                if (existingWarning) {
                    existingWarning.remove();
                }
                
                // Set warning timer (18 minutes from now)
                warningTimer = setTimeout(showIdleWarning, IDLE_TIMEOUT - WARNING_TIME);
                
                // Set logout timer (20 minutes from now)
                idleTimer = setTimeout(autoLogout, IDLE_TIMEOUT);
            }
            
            function showIdleWarning() {
                if (warningShown) return;
                warningShown = true;
                
                // Create warning modal
                const warningModal = document.createElement('div');
                warningModal.id = 'idle-warning';
                warningModal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                               background: rgba(0,0,0,0.7); z-index: 10000; display: flex; 
                               justify-content: center; align-items: center;">
                        <div style="background: white; padding: 30px; border-radius: 10px; 
                                   box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 400px; text-align: center;">
                            <div style="color: #ff6b35; font-size: 24px; margin-bottom: 15px;">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <h3 style="color: #333; margin-bottom: 15px;">Session Expiring Soon</h3>
                            <p style="color: #666; margin-bottom: 20px;">
                                Your session will expire in <strong>2 minutes</strong> due to inactivity. 
                                Click "Stay Logged In" to continue or you will be automatically logged out.
                            </p>
                            <div>
                                <button id="stay-logged-in" style="background: #28a745; color: white; border: none; 
                                       padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer; font-size: 16px;">
                                    Stay Logged In
                                </button>
                                <button id="logout-now" style="background: #dc3545; color: white; border: none; 
                                       padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer; font-size: 16px;">
                                    Logout Now
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(warningModal);
                
                // Handle buttons
                document.getElementById('stay-logged-in').onclick = function() {
                    warningModal.remove();
                    resetIdleTimer();  // Reset the timer
                };
                
                document.getElementById('logout-now').onclick = function() {
                    performLogout();
                };
            }
            
            function autoLogout() {
                performLogout();
            }
            
            function performLogout() {
                // Show logging out message
                const logoutMsg = document.createElement('div');
                logoutMsg.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                               background: rgba(0,0,0,0.8); z-index: 10001; display: flex; 
                               justify-content: center; align-items: center;">
                        <div style="background: white; padding: 30px; border-radius: 10px; text-align: center;">
                            <div style="color: #ff6b35; font-size: 24px; margin-bottom: 15px;">
                                <i class="fas fa-sign-out-alt"></i>
                            </div>
                            <h3 style="color: #333; margin-bottom: 10px;">Logging Out...</h3>
                            <p style="color: #666;">You have been logged out due to inactivity.</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(logoutMsg);
                
                // Perform logout
                setTimeout(function() {
                    window.location.href = '{{ url_for("logout") }}';
                }, 1500);
            }
            
            // Set up activity listeners
            activities.forEach(function(event) {
                document.addEventListener(event, resetIdleTimer, true);
            });
            
            // Handle window/tab close - attempt to logout server-side
            window.addEventListener('beforeunload', function(e) {
                // Send logout signal using beacon (most reliable for tab close)
                if (navigator.sendBeacon) {
                    navigator.sendBeacon('{{ url_for("logout") }}', '');
                }
                
                // Fallback: try synchronous request (may be blocked by browser)
                try {
                    var xhr = new XMLHttpRequest();
                    xhr.open('GET', '{{ url_for("logout") }}', false); // synchronous
                    xhr.send();
                } catch (e) {
                    // Ignore errors - browser may block this
                }
                
                // Clear local session data
                sessionStorage.clear();
                localStorage.removeItem('user_session');
            });
            
            // Also handle pagehide event (more reliable than beforeunload)
            window.addEventListener('pagehide', function(e) {
                if (navigator.sendBeacon) {
                    navigator.sendBeacon('{{ url_for("logout") }}', '');
                }
            });
            
            // Handle page visibility change (tab switching, minimizing)
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'visible') {
                    // User came back to the tab, reset timer
                    resetIdleTimer();
                }
            });
            
            // Initialize the idle timer
            resetIdleTimer();
            
            console.log('Auto logout initialized: ' + (IDLE_TIMEOUT / 1000 / 60) + ' minute timeout');
        })();
    </script>

    <!-- Create User Modal -->
    <div id="createUserModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div class="modal-content" style="background-color: white; margin: 5% auto; padding: 20px; border-radius: 10px; width: 500px; max-width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;"><i class="fas fa-user-plus"></i> Create New User</h3>
                <button onclick="hideCreateUserModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            
            <form id="createUserForm">
                <div style="margin-bottom: 15px;">
                    <label for="username" style="display: block; margin-bottom: 5px; font-weight: bold;">Username:</label>
                    <input type="text" id="username" name="username" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label for="full_name" style="display: block; margin-bottom: 5px; font-weight: bold;">Full Name:</label>
                    <input type="text" id="full_name" name="full_name" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label for="email" style="display: block; margin-bottom: 5px; font-weight: bold;">Email:</label>
                    <input type="email" id="email" name="email" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label for="role" style="display: block; margin-bottom: 5px; font-weight: bold;">Role:</label>
                    <select id="role" name="role" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">Select Role</option>
                        <option value="admin">Admin</option>
                        <option value="manager">Manager</option>
                        <option value="viewer">Viewer</option>
                        <option value="guest">Guest</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label for="password" style="display: block; margin-bottom: 5px; font-weight: bold;">Password:</label>
                    <input type="password" id="password" name="password" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                
                <div style="text-align: right;">
                    <button type="button" onclick="hideCreateUserModal()" class="btn" style="background: #6c757d; color: white; margin-right: 10px;">Cancel</button>
                    <button type="button" onclick="createUser()" class="btn btn-primary">Create User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div class="modal-content" style="background-color: white; margin: 5% auto; padding: 20px; border-radius: 10px; width: 500px; max-width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;"><i class="fas fa-user-edit"></i> Edit User</h3>
                <button onclick="hideEditUserModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            
            <form id="editUserForm">
                <input type="hidden" id="editUserId">
                
                <div style="margin-bottom: 15px;">
                    <label for="editUsername" style="display: block; margin-bottom: 5px; font-weight: bold;">Username:</label>
                    <input type="text" id="editUsername" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #f8f9fa;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label for="editFullName" style="display: block; margin-bottom: 5px; font-weight: bold;">Full Name:</label>
                    <input type="text" id="editFullName" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label for="editEmail" style="display: block; margin-bottom: 5px; font-weight: bold;">Email:</label>
                    <input type="email" id="editEmail" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label for="editRole" style="display: block; margin-bottom: 5px; font-weight: bold;">Role:</label>
                    <select id="editRole" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="admin">Admin</option>
                        <option value="manager">Manager</option>
                        <option value="viewer">Viewer</option>
                        <option value="guest">Guest</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label for="editPassword" style="display: block; margin-bottom: 5px; font-weight: bold;">New Password (leave blank to keep current):</label>
                    <input type="password" id="editPassword" placeholder="Enter new password to change" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center;">
                        <input type="checkbox" id="editIsActive" style="margin-right: 10px;">
                        <span style="font-weight: bold;">Active User</span>
                    </label>
                </div>
                
                <div style="text-align: right;">
                    <button type="button" onclick="hideEditUserModal()" class="btn" style="background: #6c757d; color: white; margin-right: 10px;">Cancel</button>
                    <button type="button" onclick="updateUser()" class="btn btn-primary">Update User</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Import Users Modal -->
    <div id="importUserModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div class="modal-content" style="background-color: white; margin: 5% auto; padding: 20px; border-radius: 10px; width: 500px; max-width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;"><i class="fas fa-upload"></i> Import Users from CSV</h3>
                <button onclick="hideImportModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            
            <div style="margin-bottom: 20px; padding: 15px; background-color: #e3f2fd; border-radius: 5px;">
                <h4 style="margin: 0 0 10px 0; color: #1976d2;">CSV Format Requirements:</h4>
                <ul style="margin: 0; color: #1976d2;">
                    <li>Columns: username, full_name, email, role, password</li>
                    <li>Roles: admin, manager, viewer, guest</li>
                    <li>Headers are required in the first row</li>
                </ul>
                <button onclick="downloadTemplate()" class="btn btn-info btn-sm" style="margin-top: 10px;">
                    <i class="fas fa-download"></i> Download Template
                </button>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label for="csvFile" style="display: block; margin-bottom: 5px; font-weight: bold;">Select CSV File:</label>
                <input type="file" id="csvFile" accept=".csv" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            
            <div style="text-align: right;">
                <button type="button" onclick="hideImportModal()" class="btn" style="background: #6c757d; color: white; margin-right: 10px;">Cancel</button>
                <button type="button" onclick="importUsers()" class="btn btn-primary">
                    <i class="fas fa-upload"></i> Import Users
                </button>
            </div>
        </div>
    </div>

    <!-- Upload Database Modal -->
    <div id="uploadDatabaseModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div class="modal-content" style="background-color: white; margin: 5% auto; padding: 20px; border-radius: 10px; width: 600px; max-width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;"><i class="fas fa-database"></i> Upload Monthly Water Consumption Data (GeoPackage)</h3>
                <button onclick="hideUploadModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            
            <div style="margin-bottom: 20px; padding: 15px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">
                <h4 style="margin: 0 0 10px 0; color: #856404;"><i class="fas fa-exclamation-triangle"></i> Important Notes:</h4>
                <ul style="margin: 0; color: #856404; font-size: 14px;">
                    <li>All records in the file must have the same Year and Month values</li>
                    <li>Data for existing Year/Month combinations will be rejected</li>
                    <li>Please ensure data accuracy before uploading</li>
                    <li>Large files may take several minutes to process</li>
                </ul>
            </div>
            
            <div style="margin-bottom: 20px; padding: 15px; background-color: #e3f2fd; border-radius: 5px;">
                <h4 style="margin: 0 0 10px 0; color: #1976d2;">GeoPackage Format Requirements:</h4>
                <div style="font-size: 12px; color: #1976d2;">
                    <strong>Required Columns:</strong><br>
                    Type, AccountNumber, Name, Address, MeterNo, BookNo, RateCode, Status, Cellphone, SeqNo, AREA, x, y, PRVReading, PRSReading, CumUsed, BillAmount, Year, Month
                </div>
                <button onclick="downloadDataTemplate()" class="btn btn-info btn-sm" style="margin-top: 10px;">
                    <i class="fas fa-download"></i> Download Template
                </button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label for="uploadYear" style="display: block; margin-bottom: 5px; font-weight: bold;">Year:</label>
                <input type="number" id="uploadYear" min="2020" max="2030" value="2025" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="e.g. 2025">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label for="uploadMonth" style="display: block; margin-bottom: 5px; font-weight: bold;">Month:</label>
                <select id="uploadMonth" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="">Select Month</option>
                    <option value="January">January</option>
                    <option value="February">February</option>
                    <option value="March">March</option>
                    <option value="April">April</option>
                    <option value="May">May</option>
                    <option value="June">June</option>
                    <option value="July">July</option>
                    <option value="August">August</option>
                    <option value="September">September</option>
                    <option value="October">October</option>
                    <option value="November">November</option>
                    <option value="December">December</option>
                </select>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label for="databaseFile" style="display: block; margin-bottom: 5px; font-weight: bold;">Select GeoPackage File:</label>
                <input type="file" id="databaseFile" accept=".gpkg" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <small style="color: #6c757d;">Supported format: GeoPackage (.gpkg) files only</small>
            </div>
            
            <div id="uploadProgress" style="display: none; margin-bottom: 15px;">
                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 10px;">
                    <div style="display: flex; align-items: center; margin-bottom: 5px;">
                        <i class="fas fa-spinner fa-spin" style="margin-right: 10px;"></i>
                        <span>Uploading and processing data...</span>
                    </div>
                    <div style="background: #e9ecef; height: 6px; border-radius: 3px;">
                        <div id="progressBar" style="background: #007bff; height: 100%; width: 0%; border-radius: 3px; transition: width 0.3s;"></div>
                    </div>
                </div>
            </div>
            
            <div style="text-align: right;">
                <button type="button" onclick="hideUploadModal()" class="btn" style="background: #6c757d; color: white; margin-right: 10px;">Cancel</button>
                <button type="button" onclick="uploadDatabase()" class="btn btn-success" id="uploadButton">
                    <i class="fas fa-upload"></i> Upload Data
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Month Data Modal -->
    <div id="deleteDataModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div class="modal-content" style="background-color: white; margin: 10% auto; padding: 20px; border-radius: 10px; width: 500px; max-width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #dc3545;"><i class="fas fa-trash"></i> Delete Monthly Water Consumption Data</h3>
                <button onclick="hideDeleteModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            
            <div style="margin-bottom: 20px; padding: 15px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">
                <h4 style="margin: 0 0 10px 0; color: #856404;"><i class="fas fa-exclamation-triangle"></i> Warning:</h4>
                <ul style="margin: 0; color: #856404; font-size: 14px;">
                    <li><strong>This action cannot be undone!</strong></li>
                    <li>All records for the selected month will be permanently deleted</li>
                    <li>This will affect reports, analytics, and exported data</li>
                    <li>Ensure you have backups if needed</li>
                </ul>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label for="deleteYear" style="display: block; margin-bottom: 5px; font-weight: bold;">Year:</label>
                <input type="number" id="deleteYear" min="2020" max="2030" value="2025" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="e.g. 2025">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label for="deleteMonth" style="display: block; margin-bottom: 5px; font-weight: bold;">Month:</label>
                <select id="deleteMonth" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="">Select Month to Delete</option>
                    <option value="January">January</option>
                    <option value="February">February</option>
                    <option value="March">March</option>
                    <option value="April">April</option>
                    <option value="May">May</option>
                    <option value="June">June</option>
                    <option value="July">July</option>
                    <option value="August">August</option>
                    <option value="September">September</option>
                    <option value="October">October</option>
                    <option value="November">November</option>
                    <option value="December">December</option>
                </select>
            </div>

            <div id="deletePreview" style="display: none; margin-bottom: 15px; padding: 15px; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px;">
                <h5 style="margin: 0 0 5px 0; color: #721c24;">Records to be deleted:</h5>
                <div style="color: #721c24; font-weight: bold;" id="deletePreviewCount">Loading...</div>
            </div>
            
            <div style="text-align: right;">
                <button type="button" onclick="hideDeleteModal()" class="btn" style="background: #6c757d; color: white; margin-right: 10px;">Cancel</button>
                <button type="button" onclick="checkRecordsToDelete()" class="btn btn-warning" id="checkDeleteButton" style="margin-right: 10px;">
                    <i class="fas fa-search"></i> Check Records
                </button>
                <button type="button" onclick="deleteMonthData()" class="btn btn-danger" id="deleteButton" style="display: none;">
                    <i class="fas fa-trash"></i> Delete Data
                </button>
            </div>
        </div>
    </div>
</body>
</html>
